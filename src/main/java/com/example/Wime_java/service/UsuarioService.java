package com.example.Wime_java.service;

import java.time.LocalDateTime;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCrypt;
import org.springframework.stereotype.Service;

import com.example.Wime_java.model.Usuario;
import com.example.Wime_java.repository.UsuarioRepository;

@Service
public class UsuarioService {

    @Autowired
    private UsuarioRepository usuarioRepository;

    public Optional<Usuario> login(String email, String contrasena) {
        Optional<Usuario> usuarioOpt = usuarioRepository.findByEmailUsuario(email);

        if (usuarioOpt.isEmpty()) {
            System.out.println("‚ùå Usuario no encontrado con email: " + email);
            return Optional.empty();
        }

        Usuario usuario = usuarioOpt.get();

        // üîé Logs de depuraci√≥n
        System.out.println("üëâ Email recibido: " + email);
        System.out.println("üëâ Contrase√±a ingresada: " + contrasena);
        System.out.println("üëâ Hash almacenado en BD: " + usuario.getContrasenaUsuario());

        // üîë Validar contrase√±a (BCrypt como en PHP password_hash)
        boolean passwordOk = BCrypt.checkpw(contrasena, usuario.getContrasenaUsuario());
        System.out.println("üîç Resultado BCrypt: " + passwordOk);

        if (!passwordOk) {
            System.out.println("‚ùå Contrase√±a incorrecta para usuario: " + email);
            return Optional.empty();
        }

        // üõë Verificar estado
        if (!"Activo".equalsIgnoreCase(usuario.getEstado())) {
            System.out.println("‚ö†Ô∏è Usuario no est√° activo: " + email);
            return Optional.empty();
        }

        // ‚è≥ Verificar √∫ltimo login (60 d√≠as de inactividad = inactivo)
        if (usuario.getUltimoLogin() != null) {
            LocalDateTime limite = usuario.getUltimoLogin().plusDays(60);
            if (LocalDateTime.now().isAfter(limite)) {
                usuario.setEstado("Inactivo");
                usuarioRepository.save(usuario);
                System.out.println("‚ö†Ô∏è Usuario inactivo por m√°s de 60 d√≠as: " + email);
                return Optional.empty();
            }
        }

        // üîÑ Actualizar √∫ltimo login
        usuario.setUltimoLogin(LocalDateTime.now());
        usuarioRepository.save(usuario);

        System.out.println("‚úÖ Login exitoso para: " + email);
        return Optional.of(usuario);
    }
}
