<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Usuarios Registrados</title>
    <link rel="stylesheet" href="/Wime/public/bootstrap-5.3.7-dist/css/bootstrap.min.css">
</head>
<body class="container py-5">

    <h2 class="text-center" id="welcome-message"></h2>

    <h2 class="mb-4">Usuarios Registrados</h2>

    <div id="user-table-container">
        <p class="alert alert-info" id="loading-message">Cargando usuarios...</p>
    </div>
    
    <script src="/Wime/public/bootstrap-5.3.7-dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // NOTE: Session validation and admin check MUST be done on the backend API.
        
        async function fetchAndRenderUsers() {
            const tableContainer = document.getElementById('user-table-container');
            const welcomeMessage = document.getElementById('welcome-message');
            tableContainer.innerHTML = ''; 

            try {
                // 1. API call to fetch user data
                const response = await fetch('/api/admin/usuarios'); 
                
                if (response.status === 403) { // 403 Forbidden for non-admins
                    tableContainer.innerHTML = "<h2 style='color: red; text-align: center;'>❌ Acceso denegado. Solo administradores.</h2>";
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Error al cargar los usuarios.');
                }

                const data = await response.json();
                const { usuarioActual, usuarios } = data; // Assuming the API returns the current user and the list

                welcomeMessage.textContent = `Bienvenido, ${usuarioActual.NombreUsuario}`;

                if (usuarios.length === 0) {
                    tableContainer.innerHTML = '<p class="alert alert-info">No hay usuarios registrados.</p>';
                    return;
                }

                // 2. Create and populate the table
                let html = `
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Edad</th>
                                <th>Fecha de Registro</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                usuarios.forEach(user => {
                    const buttonText = user.Estado === "Activo" ? "Inactivar" : "Activar";
                    const buttonClass = user.Estado === "Activo" ? "btn-warning" : "btn-success";

                    html += `
                        <tr>
                            <td>${user.IDusuario}</td>
                            <td>${user.NombreUsuario}</td>
                            <td>${user.EmailUsuario}</td>
                            <td>${user.Edad}</td>
                            <td>${user.FechaRegistro}</td>
                            <td>${user.Tipo}</td>
                            <td>${user.Estado}</td>
                            <td>
                                <button type="button" class="btn ${buttonClass} btn-sm" 
                                    data-user-id="${user.IDusuario}" 
                                    data-current-estado="${user.Estado}"
                                    onclick="updateUserStatus(${user.IDusuario}, '${user.Estado}')">
                                    ${buttonText}
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
                tableContainer.innerHTML = html;

            } catch (error) {
                console.error(error);
                tableContainer.innerHTML = '<p class="alert alert-danger">Error: ' + error.message + '</p>';
            }
        }

        async function updateUserStatus(id, currentStatus) {
            const newStatus = currentStatus === 'Activo' ? 'Inactivo' : 'Activo';
            
            try {
                // 3. API call to update the user's status
                const response = await fetch(`/api/admin/usuarios/${id}/estado`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ estado: newStatus })
                });

                if (!response.ok) {
                    throw new Error('Error al actualizar el estado.');
                }

                alert(`Estado del usuario ${id} cambiado a ${newStatus}.`);
                fetchAndRenderUsers(); // Re-render the list
            } catch (error) {
                alert(error.message);
            }
        }

        fetchAndRenderUsers(); 
    </script>
</body>
</html>